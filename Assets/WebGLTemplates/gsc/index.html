<!DOCTYPE html>
<html lang="en-us" style="height: 100%; margin: 0; padding: 0;">

<head>
  <meta charset="utf-8">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>幸运星</title>
  <meta http-equiv="Cache-Control" content="public, max-age=31536000">
  <meta http-equiv="Pragma" content="cache">
  <meta http-equiv="Expires" content="Fri, 31 Dec 9999 23:59:59 GMT">
  <link rel="shortcut icon" href="TemplateData/XYXIcon.ico">
  <link rel="stylesheet" href="TemplateData/style.css">
  <video id="noSleepVideo" src="TemplateData/1.mp4" loop muted playsinline autoplay style="position: absolute; width: 1px; height: 1px; left: -9999px;"></video>
  <!-- NoSleep.js 用于解决Safari浏览器常亮问题 -->
  <script src="https://unpkg.com/nosleep.js@0.12.0/dist/NoSleep.min.js"></script>
  <style>
    html,
    body {
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }

    #unity-container {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
    }

    /* iOS Safari特定修复 */
    @supports (-webkit-touch-callout: none) {
      #unity-container {
        position: fixed;
        width: 100% !important;
        height: 100% !important;
        left: 0;
        top: 0;
        transform: none;
      }

      #unity-canvas {
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        width: 100% !important;
        height: 100% !important;
        object-fit: contain;
      }
    }
  </style>
</head>

<body>
  <div id="unity-container">
    <canvas id="unity-canvas" tabindex="-1"></canvas>
    <div id="unity-loading-bar">
      <div id="loading-text">加载中...</div>
      <div id="unity-progress-bar-empty">
        <div id="unity-progress-bar-full"></div>
      </div>
    </div>
  </div>
  <script>
    var container = document.querySelector("#unity-container");
    var canvas = document.querySelector("#unity-canvas");
    var loadingBar = document.querySelector("#unity-loading-bar");
    var progressBarFull = document.querySelector("#unity-progress-bar-full");
    var loadingText = document.querySelector("#loading-text");

    // 加载文字闪烁效果
    function blinkText() {
      if (loadingText.style.visibility === "hidden") {
        loadingText.style.visibility = "visible";
      } else {
        loadingText.style.visibility = "hidden";
      }
    }

    // 设置闪烁间隔
    var blinkInterval = setInterval(blinkText, 500);

    // 检测设备类型
    var isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    var isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);

    // 适配屏幕
    function resizeGame() {
      var gameAspectRatio = 9 / 16; // 1080:1920的比例

      if (isMobile) {
        // 移动端全屏适配
        var width = window.innerWidth;
        var height = window.innerHeight;

        container.style.width = width + "px";
        container.style.height = height + "px";
        canvas.style.width = width + "px";
        canvas.style.height = height + "px";

        // iOS Safari额外处理
        if (isIOS) {
          // 避免iOS设备上的缩放问题
          document.body.style.height = window.innerHeight + 'px';
          // 防止iOS Safari顶部导航栏隐藏时布局变化
          window.scrollTo(0, 0);
        }
      } else {
        // PC端1080*1920比例适配
        var width = 1080;
        var height = 1920;

        // 如果窗口大小小于1080*1920，则等比例缩小
        if (window.innerWidth < width || window.innerHeight < height) {
          var windowAspectRatio = window.innerWidth / window.innerHeight;

          if (windowAspectRatio < gameAspectRatio) {
            width = window.innerWidth;
            height = width / gameAspectRatio;
          } else {
            height = window.innerHeight;
            width = height * gameAspectRatio;
          }
        }

        container.style.width = width + "px";
        container.style.height = height + "px";
        canvas.style.width = width + "px";
        canvas.style.height = height + "px";
      }
    }

    // 初始调用一次适配函数
    resizeGame();

    // 当窗口大小变化时重新适配
    window.addEventListener('resize', resizeGame);

    // 禁止滚动条
    // document.body.style.overflow = 'hidden';

    var buildUrl = "Build";
    var loaderUrl = buildUrl + "/WebGL.loader.js";
    var config = {
      dataUrl: buildUrl + "/WebGL.data.unityweb",
      frameworkUrl: buildUrl + "/WebGL.framework.js.unityweb",
      codeUrl: buildUrl + "/WebGL.wasm.unityweb",
      streamingAssetsUrl: "StreamingAssets",
      companyName: "xin",
      productName: "幸运星",
      productVersion: "1.0.0",
    };

    // 添加viewport元标签，保证移动端适配
    var meta = document.createElement('meta');
    meta.name = 'viewport';
    meta.content = 'width=device-width, height=device-height, initial-scale=1.0, user-scalable=no, shrink-to-fit=yes, viewport-fit=cover';
    document.getElementsByTagName('head')[0].appendChild(meta);
    canvas.style.background = "url('" + buildUrl + "/WebGL.jpg') center / cover";
    loadingBar.style.display = "block";

    // iOS设备添加额外事件监听
    if (isIOS) {
      // 处理iOS Safari的orientation change事件
      window.addEventListener('orientationchange', function () {
        setTimeout(function () {
          window.scrollTo(0, 0);
          resizeGame();
        }, 100);
      });

      // 处理iOS Safari的resize事件
      window.addEventListener('resize', function () {
        if (document.activeElement.tagName === 'INPUT') {
          // 处理iOS键盘事件
          window.scrollTo(0, 0);
        }
      });
    }

    var script = document.createElement("script");
    script.src = loaderUrl;
    script.onload = () => {
      createUnityInstance(canvas, config, (progress) => {
        progressBarFull.style.width = 100 * progress + "%";
      }).then((unityInstance) => {
        window.unityInstance = unityInstance;
        loadingBar.style.display = "none";
        clearInterval(blinkInterval); // 清除闪烁效果
      }).catch((message) => {
        alert(message);
      });
    };
    document.body.appendChild(script);
  </script>
  <script>
    // 监听 Unity 中触发的清理缓存事件（来自 .jslib 的 dispatchEvent）
    window.addEventListener("ClearIndexedDB", () => {
      if (indexedDB.databases) {
        indexedDB.databases().then((dbs) => {
          let deleteCount = 0;
          dbs.forEach((db) => {
            indexedDB.deleteDatabase(db.name);
            console.log("已删除 IndexedDB 数据库: " + db.name);
            deleteCount++;
          });

          // 简单延迟后刷新（防止数据库还在关闭中）
          if (deleteCount > 0) {
            setTimeout(() => {
              window.location.reload();
            }, 500);
          }
        });
      }
    });
  </script>
  <script>
    // 确保视频播放以保持页面常亮（防止设备休眠）
    document.addEventListener('DOMContentLoaded', function() {
      var video = document.getElementById('noSleepVideo');
      // 初始化NoSleep对象（专门解决Safari常亮问题）
      var noSleep = null;
      if (typeof NoSleep !== 'undefined') {
        noSleep = new NoSleep();
      }
      
      // 尝试立即播放视频
      function playVideo() {
        if (video.paused) {
          var playPromise = video.play();
          
          if (playPromise !== undefined) {
            playPromise.then(_ => {
              console.log('视频播放成功，页面保持常亮');
            })
            .catch(error => {
              console.log('视频播放失败:', error);
            });
          }
        }
      }
      
      // 激活NoSleep（针对Safari）- 仅在用户交互事件中调用
      function enableNoSleep() {
        if (noSleep && !noSleep.enabled) {
          try {
            noSleep.enable();
            console.log('NoSleep已激活');
          } catch (e) {
            console.log('NoSleep激活失败:', e);
          }
        }
      }
      
      // 首次尝试播放视频（不激活NoSleep）
      playVideo();
      
      // 在用户交互事件中激活NoSleep并播放视频
      ['click', 'touchstart', 'touchend', 'mousedown', 'keydown'].forEach(function(eventName) {
        document.addEventListener(eventName, function() {
          playVideo();
          // 仅在用户交互时尝试激活NoSleep
          enableNoSleep();
        }, { passive: true });
      });
      
      // 定期检查视频是否在播放（不激活NoSleep）
      setInterval(function() {
        playVideo();
      }, 5000);
      
      // 监听页面可见性变化（不激活NoSleep）
      document.addEventListener('visibilitychange', function() {
        if (document.visibilityState === 'visible') {
          playVideo();
        }
      });

      // 专门针对iOS Safari的额外处理
      var isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
      var isSafari = /Safari/i.test(navigator.userAgent) && !/Chrome/i.test(navigator.userAgent);
      
      if (isIOS || isSafari) {
        // 额外的处理：在有用户交互后，每30秒尝试重新激活常亮
        var hasUserInteracted = false;
        
        // 监听用户交互
        ['click', 'touchstart'].forEach(function(eventName) {
          document.addEventListener(eventName, function() {
            hasUserInteracted = true;
          }, { passive: true, once: false });
        });
        
        setInterval(function() {
          // 只有在用户已经交互过的情况下才尝试重新激活
          if (hasUserInteracted && noSleep) {
            try {
              // 不需要先禁用，直接尝试激活即可
              noSleep.enable();
              console.log('iOS Safari: NoSleep已重新激活');
            } catch (e) {
              console.log('iOS Safari: NoSleep重新激活失败:', e);
            }
          }
        }, 30000);
      }
    });
  </script>
</body>

</html>